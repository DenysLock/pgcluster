groups:
  - name: postgres_alerts
    rules:
      - alert: PostgresDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL on {{ $labels.instance }} is not responding."

      - alert: PostgresConnectionsHigh
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL connections high"
          description: "PostgreSQL on {{ $labels.instance }} is using {{ $value | humanizePercentage }} of max connections."

      - alert: PostgresConnectionsCritical
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.95
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL connections critical"
          description: "PostgreSQL on {{ $labels.instance }} is using {{ $value | humanizePercentage }} of max connections."

      - alert: PostgresDeadlocks
        expr: increase(pg_stat_database_deadlocks[5m]) > 5
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL deadlocks detected"
          description: "PostgreSQL on {{ $labels.instance }} has {{ $value }} deadlocks in the last 5 minutes."

      - alert: PostgresSlowQueries
        expr: pg_stat_activity_max_tx_duration > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL slow queries"
          description: "PostgreSQL on {{ $labels.instance }} has queries running for more than 5 minutes."
